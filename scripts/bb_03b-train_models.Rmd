---
title: "R Notebook"
output: html_notebook
---

```{r}
library(biomod2)
library(raster)
library(rgdal)

library(caret)
library(parallel)
library(doParallel)
```

## Load data
```{r}
### Import observations: land classification file 
peat_depth_presabs <- readOGR(dsn = "../data/peat_depth_presabs_YD.shp", verbose = TRUE)

FEP_presabs <- readOGR(dsn = "../data/FEP_presabs_YD.shp.shp", verbose = TRUE)
```

merge observations from different sources
```{r}
FEP_presabs <- FEP_presabs[,"bbog"] #save only required column

observations <- rbind.SpatialPointsDataFrame(FEP_presabs, peat_depth_presabs)

observations
plot(observations, col = observations$bbog, pch = 1, cex = 0.2)
```



```{r}
# model

#predictors


# Import environmental and topographic data
elev <- raster("../data/topo_env_data.tif", band = 1)
surf <- raster("../data/topo_env_data.tif", band = 2)
inflow <- raster("../data/topo_env_data.tif", band = 3)
outflow <- raster("../data/topo_env_data.tif", band = 4)
slope <- raster("../data/topo_env_data.tif", band = 5)
aspect <- raster("../data/topo_env_data.tif", band = 6)
moorline <- raster("../data/topo_env_data.tif", band = 7)

# Import UKCP09 climate data
gdd_1960_90_ann <- raster("../data/ukcp09GriddedDataAnnPrepd.tif", band = 1)
gsl_1960_90_ann <- raster("../data/ukcp09GriddedDataAnnPrepd.tif", band = 2)
rain_1960_90_annual <- raster("../data/ukcp09GriddedDataAnnPrepd.tif", band = 3)
rain_daily_mean_1960_90_annual <- raster("../data/ukcp09GriddedDataAnnPrepd.tif", band = 4)
raindays_1mm_1960_90_annual <- raster("../data/ukcp09GriddedDataAnnPrepd.tif", band = 5)
raindays_10mm_1960_90_annual <- raster("../data/ukcp09GriddedDataAnnPrepd.tif", band = 6)
temp_mean_1960_90_annual <- raster("../data/ukcp09GriddedDataAnnPrepd.tif", band = 7)
temp_min_1960_90_annual <- raster("../data/ukcp09GriddedDataAnnPrepd.tif", band = 8)
temp_max_1960_90_annual <- raster("../data/ukcp09GriddedDataAnnPrepd.tif", band = 9)
```

make a raster stack
```{r}
#Model$coefnames

predictors <- stack(
  elev, aspect, slope, outflow, inflow, surf, moorline,
  gdd_1960_90_ann, gsl_1960_90_ann,
  rain_1960_90_annual, rain_daily_mean_1960_90_annual,
  raindays_10mm_1960_90_annual, raindays_1mm_1960_90_annual,
  temp_mean_1960_90_annual, temp_min_1960_90_annual, 
  temp_max_1960_90_annual
)

names(predictors) <- c("elev", "aspect", "slope", "outflow", "inflow", "surf", "moorline",
                       "gdd", "gsl", "rain_ann", "rain_daily", "raindays_10mm", 
                       "raindays_1mm", "temp_mean", "temp_min", "temp_max")
```

crop to training data extent

```{r}
#load observations to get extent
#observationsSPDF <- readOGR(dsn = "../data/observations.shp", verbose = TRUE)
boundbox <- observations@bbox; boundbox 

predictors <- raster::crop(x = predictors, y = boundbox)

predictors <- stack(predictors)
```

###wrangle
```{r}
observations.xy <- data.frame(observations@coords)
names(observations.xy) <- c("x", "y")

observations.pa <- data.frame(observations$bbog, stringsAsFactors = FALSE)

observations.pa$pa <- as.numeric(3)

observations.pa[which(observations.pa$observations.bbog == "present"), "pa"] <- 1
observations.pa[which(observations.pa$observations.bbog == "absent"), "pa"] <- 0
observations.pa$observations.bbog <- NULL
  
head(observations.xy)
head(observations.pa)
```

We have: 
observations.pa = presence absence as a dataframe
observations.xy = coordinates of presence absence observations
predictors = raster stack of predictors


#extract predictor data from raster stack using observation 

```{r}
myBiomodData <- BIOMOD_FormatingData(resp.var = observations.pa$pa, 
                                     expl.var = predictors, 
                                      resp.xy = observations.xy, 
                                     resp.name = "blanket.bog")
myBiomodData
plot(myBiomodData)
```

# set up modelling options
```{r}
myBiomodOption <- BIOMOD_ModelingOptions()     #e.g. RF = list(maxnodes = 40))
```

# train the model

```{r}
myBiomodModelOut <- BIOMOD_Modeling(myBiomodData, models = c("RF", "SRE", "GLM"), 
                                    models.options = myBiomodOption, NbRunEval = 1, 
                                    DataSplit = 70,VarImport = 3, 
                                    models.eval.meth = c("ROC", "TSS"))
```



```{r}
myBiomodModelOut
```

# look how good my models are

```{r}
myBiomodModelEval <- get_evaluations(myBiomodModelOut)
myBiomodModelEval[,"Testing.data",,,]
myBiomodModelEval[,"Cutoff",,,] #prediction (0:1) multiplied by 1000
myBiomodModelEval
```

#variable importance
```{r}
getModelsVarImport(myBiomodModelOut)
```

# plot model

```{r}
mod.plot<-BIOMOD_LoadModels(myBiomodModelOut,models=c('SRE','RF','GLM'))
strip.plots<-response.plot2(models=mod.plot[c(2,4,6)],
                            Data=get_formal_data(myBiomodModelOut,'expl.var'),
                            show.variables = get_formal_data(myBiomodModelOut,'expl.var.names'),
                            do.bivariate = F,
                            fixed.var.metric = "median",
                            legend=F,
                            col=rainbow(n=length(mod.plot)/2,start=.7,end=1,alpha=1),
                            display_title=F,
                            data.species = get_formal_data(myBiomodModelOut,'resp.var'))

```

# the route of ensemble modelling

```{r}
myBiomodEM <- BIOMOD_EnsembleModeling(myBiomodModelOut, chosen.models = "all", eval.metric = c("ROC"), 
                                      eval.metric.quality.threshold = c(0.9), prob.cv = TRUE, 
                                      prob.ci = TRUE, prob.ci.alpha = 0.05, prob.median = TRUE, 
                                      prob.mean.weight = TRUE, committee.averaging = TRUE)
```


```{r}
getEMeval(myBiomodEM)
```

look at weighted mean (weighted by roc score) and median (less sensitive to outliers)


# do the projections

```{r}
myBiomodProj <- BIOMOD_Projection(myBiomodModelOut, new.env = predictors, proj.name = "current", 
                                  selected.models = "all", binary.meth = "ROC")
```

```{r}
plot(myBiomodProj, str.grep = "GLM")
```

# ensemble it

```{r}
myBiomodEF <- BIOMOD_EnsembleForecasting(projection.output = myBiomodProj, EM.output = myBiomodEM) #ensemble forecast 
```


apply the cutoff
```{r}
wmean.ras <- raster("../scripts/blanket.bog/proj_current/individual_projections/blanket.bog_EMwmeanByROC_mergedAlgo_RUN1_AllData.gri")

wmean.ras[which(wmean.ras[] < 549)] <- 0

plot(wmean.ras)
```

# export

```{r}
writeRaster(wmean.ras, "../outputs/bb_EM_mod1a_wmean.tif")
```





